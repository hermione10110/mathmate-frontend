<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ““ Mathmate : êµ¬ì¡°ë¥¼ ê¿°ëš«ëŠ” ìˆ˜í•™</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&family=Playfair+Display:wght@600&family=Caveat:wght@600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Pretendard', sans-serif; word-break: keep-all; }
        .en { font-family: 'Playfair Display', serif; }
        #chat::-webkit-scrollbar { width: 4px; }
        #chat::-webkit-scrollbar-thumb { background: #fda4af; border-radius: 10px; }

        .note {
            background:#fff; border:2px solid #fecaca;
            box-shadow: 4px 4px 0 #fda4af; transition: all 0.2s;
            position: relative;
        }
        .note::before {
            content:"ğŸ“’ Math-Note"; display:block; font-size:.7rem; font-weight:800;
            color:#e11d48; border-bottom:1px dashed #fda4af; margin-bottom:.5rem; opacity: 0.7;
        }
        
        .user-bubble {
            background: #be123c; color: white; border-radius: 18px 18px 2px 18px;
            padding: 10px 16px; max-width: 85%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .loading-dots::after {
            content: '.'; animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        
        .preview-img { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 2px solid #fda4af; }
        .ai-img { max-width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid #fecaca; }
    </style>
</head>

<body class="bg-rose-50 h-screen flex flex-col overflow-hidden">

    <header class="bg-gradient-to-r from-rose-500 to-pink-500 text-white p-5 shadow-md flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-extrabold en tracking-tighter">Mathmate âœï¸</h1>
            <p class="text-[10px] opacity-90 uppercase font-bold tracking-widest text-white">Concept over Calculation</p>
        </div>
        <div id="user-display" class="text-xs font-bold bg-white/20 px-4 py-1.5 rounded-full text-white"></div>
    </header>

    <div class="bg-white border-b border-rose-100 p-3 flex gap-3 overflow-x-auto items-center shadow-sm text-xs font-bold">
        <select id="modeSelect" class="bg-rose-50 border-none rounded-lg px-3 py-1.5 outline-none text-rose-700">
            <option value="chat">ğŸ’¬ ê¸°ë³¸ ì„¤ëª…</option>
            <option value="map">ğŸ“Š ê°œë…ë§µ ëª¨ë“œ</option>
            <option value="analysis">âœï¸ í’€ì´ ë¶„ì„</option>
            <option value="thinking">ğŸ§  ì§ˆë¬¸ ìœ ë„</option>
        </select>

        <select id="examMode" class="bg-rose-50 border-none rounded-lg px-3 py-1.5 outline-none text-rose-700">
            <option value="ë‚´ì‹  ì§‘ì¤‘">ğŸ« ë‚´ì‹  ì§‘ì¤‘</option>
            <option value="ìˆ˜ëŠ¥/í‰ê°€ì›">ğŸ¯ ìˆ˜ëŠ¥/í‰ê°€ì›</option>
        </select>

        <select id="tone" class="bg-rose-50 border-none rounded-lg px-3 py-1.5 outline-none text-rose-700">
            <option value="ë‹¤ì •í•œ ì¹œêµ¬">ğŸ¤ ë‹¤ì •í•œ ì¹œêµ¬</option>
            <option value="ì—„ê²©í•œ ì„ ìƒë‹˜">ğŸ”¥ ì—„ê²©í•œ ìŒ¤</option>
            <option value="íŒ©íŠ¸í­ê²©ê¸°">ğŸ˜ íŒ©í­ ëª¨ë“œ</option>
        </select>
        
        <button onclick="resetData()" class="ml-auto text-rose-300 hover:text-rose-500 transition-colors">ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>

    <main class="flex-1 flex flex-col overflow-hidden">
        <div id="chat" class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="note p-5 rounded-2xl">
                ì•ˆë…•! ë‚˜ëŠ” ë„ˆì˜ ìˆ˜í•™ í˜ì´ìŠ¤ë©”ì´ì»¤ **Mathmate**ì•¼. <br>
                ê¶ê¸ˆí•œ ê°œë…ì´ë‚˜ í’€ë¦¬ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆë‹¤ë©´ ì–¸ì œë“  ë¬¼ì–´ë´. ì‚¬ì§„ì„ ì°ì–´ì„œ ì˜¬ë ¤ì¤˜ë„ ì¢‹ì•„! ğŸ”¥
            </div>
        </div>
    </main>

    <div id="loading" class="hidden px-6 py-2 text-xs font-bold text-rose-500 animate-pulse">
        Mathmateê°€ êµ¬ì¡° ë¶„ì„ ì¤‘<span class="loading-dots"></span>
    </div>

    <div class="bg-white p-5 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.05)]">
        <div id="preview-container" class="flex gap-3 mb-3 ml-2"></div>
        <form id="form" class="max-w-5xl mx-auto flex gap-3 items-center">
            <label for="image-input" class="cursor-pointer p-3 bg-rose-50 rounded-2xl hover:bg-rose-100 transition-all shadow-sm">
                <span class="text-2xl">ğŸ–¼ï¸</span>
                <input type="file" id="image-input" accept="image/*" class="hidden">
            </label>
            <input id="input" autocomplete="off" class="flex-1 bg-rose-50 border-2 border-rose-100 rounded-2xl px-6 py-4 text-sm focus:outline-none focus:border-rose-400 transition-all shadow-inner" placeholder="ìˆ˜í•™ ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì¤˜..."/>
            <button type="submit" class="bg-rose-500 text-white font-bold px-8 py-4 rounded-2xl hover:bg-rose-600 transition-all shadow-lg shadow-rose-200 active:scale-95">ì „ì†¡</button>
        </form>
    </div>

    <div id="login-overlay" class="fixed inset-0 bg-rose-900/50 backdrop-blur-md flex items-center justify-center z-50 hidden">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl text-center space-y-6 max-w-sm w-full mx-4">
            <h2 class="text-3xl font-black text-rose-600 en">Who are you?</h2>
            <p class="text-gray-500 text-sm">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ìˆ˜í•™ ì •ë³µì„ ì‹œì‘í•´ë´!</p>
            <input id="nickname-input" class="w-full border-2 border-rose-100 rounded-2xl px-5 py-3 text-center outline-none focus:border-rose-400 text-lg font-bold" placeholder="ë‹‰ë„¤ì„">
            <button onclick="doLogin()" class="w-full bg-rose-500 text-white py-4 rounded-2xl font-bold text-lg hover:bg-rose-600 transition-all shadow-lg shadow-rose-200">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

<script>

/* ================= STATE ================= */
let user = localStorage.getItem("mathmate_user") || "";
let chatHistory = [];
let selectedImageBase64 = null;

/* ================= INIT ================= */
window.onload = () => {
    if(!user) {
        document.getElementById('login-overlay').classList.remove('hidden');
    } else {
        updateUserDisplay();
    }
};

function updateUserDisplay() {
    document.getElementById('user-display').innerText = `STUDENT: ${user}`;
    document.getElementById('login-overlay').classList.add('hidden');
}

function doLogin() {
    const val = document.getElementById('nickname-input').value.trim();
    if(!val) return;
    user = val;
    localStorage.setItem("mathmate_user", user);
    updateUserDisplay();
    addAI(`ë°˜ê°€ì›Œ **${user}**! ìˆ˜í•™ì˜ êµ¬ì¡°ë¥¼ ê¿°ëš«ëŠ” í†µì°°ì„ ì–»ì„ ì¤€ë¹„ ëì–´? ğŸ”¥`);
}

function resetData() {
    if(confirm("ëŒ€í™” ê¸°ë¡ê³¼ ì„¤ì •ì´ ëª¨ë‘ ì§€ì›Œì ¸. ì´ˆê¸°í™”í• ê¹Œ?")) {
        localStorage.clear();
        location.reload();
    }
}

/* ================= UI & IMAGE ================= */
const imageInput = document.getElementById('image-input');
const previewContainer = document.getElementById('preview-container');

imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        selectedImageBase64 = e.target.result.split(',')[1];
        previewContainer.innerHTML = `
            <div class="relative group">
                <img src="${e.target.result}" class="preview-img">
                <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-rose-600 text-white rounded-full w-6 h-6 text-xs font-bold shadow-md">Ã—</button>
            </div>`;
    };
    reader.readAsDataURL(file);
});

function clearImage() {
    selectedImageBase64 = null;
    previewContainer.innerHTML = '';
    imageInput.value = '';
}

function addUser(text, imgData = null) {
    const div = document.createElement('div');
    div.className = "flex justify-end flex-col items-end gap-2";
    let imgHtml = imgData ? `${imgData}" class="max-w-[250px] rounded-2xl border-4 border-white shadow-md mb-1">` : "";
    div.innerHTML = `${imgHtml}<div class="user-bubble text-sm font-semibold">${text}</div>`;
    document.getElementById('chat').appendChild(div);
    scrollChat();
}

function addAI(t) {
    const div = document.createElement('div');
    div.className = "note p-5 rounded-2xl text-sm leading-relaxed text-gray-700 animate-in fade-in slide-in-from-bottom-3 duration-500";
    div.innerHTML = marked.parse(t);
    document.getElementById('chat').appendChild(div);
    
    if (window.MathJax) {
        MathJax.typesetPromise([div]);
    }
    scrollChat();
}

function scrollChat() { 
    const chat = document.getElementById('chat');
    chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' }); 
}

/* ================= API LOGIC ================= */
async function askGemini(prompt, base64Image) {
    const loading = document.getElementById('loading');
    loading.classList.remove('hidden');

    const mode = document.getElementById('modeSelect').value;
    const exam = document.getElementById('examMode').value;
    const tone = document.getElementById('tone').value;

    const systemMsg = `ë„ˆëŠ” ê³ ë“±í•™êµ ìˆ˜í•™ ì „ë¬¸ AI íŠœí„° 'Mathmate'ë‹¤. 
    í˜„ì¬ ì‚¬ìš©ì: ${user}, ëª¨ë“œ: ${mode}, ì‹œí—˜ìœ í˜•: ${exam}, ë§íˆ¬: ${tone}.
    [í•µì‹¬ ì§€ì¹¨]
    1. ìˆ˜ì‹ì€ ë°˜ë“œì‹œ LaTeX($...$, $$...$$)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¹”ë”í•˜ê²Œ ë Œë”ë§í•˜ì„¸ìš”.
    2. í•¨ìˆ˜ì  ê´€ì (ì…ë ¥-ì¶œë ¥)ê³¼ ê¸°í•˜í•™ì  ì˜ë¯¸ë¥¼ ê°•ì¡°í•˜ì„¸ìš”.
    3. ì¹œê·¼í•˜ë©´ì„œë„ ìˆ˜í•™ì  ì „ë¬¸ì„±ì„ ìœ ì§€í•˜ì„¸ìš”.
    4. ì •ë‹µì„ ë°”ë¡œ ì£¼ê¸°ë³´ë‹¤ í•´ê²°ì˜ ì‹¤ë§ˆë¦¬ë¥¼ ë¨¼ì € ì œì‹œí•˜ì„¸ìš”.
    5. ë‹µë³€ ë§ˆì§€ë§‰ì—” ë°˜ë“œì‹œ ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ 'ë„ì „ì ì¸ ìƒê°í•  ê±°ë¦¬'ë¥¼ 1ê°œ ë˜ì§€ì„¸ìš”.
    6. ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ê¸°ì–µí•˜ì—¬ ë§¥ë½ì— ë§ê²Œ ë‹µë³€í•˜ì„¸ìš”.`;

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.MODEL}:generateContent?key=${CONFIG.API_KEY}`;
    
    // ì²« ë©”ì‹œì§€ì— ì‹œìŠ¤í…œ ê°€ì´ë“œ ê²°í•©
    let currentPrompt = chatHistory.length === 0 ? `[ì§€ì¹¨: ${systemMsg}] ${prompt}` : prompt;
    
    const userParts = [{ text: currentPrompt || "ì´ ì´ë¯¸ì§€ë¥¼ ìˆ˜í•™ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  ì„¤ëª…í•´ì¤˜." }];
    if (base64Image) {
        userParts.push({ inline_data: { mime_type: "image/jpeg", data: base64Image } });
    }

    chatHistory.push({ role: "user", parts: userParts });

    try {
        const response = await fetch("/.netlify/functions/ask", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ contents: chatHistory })
});
        
        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        const aiText = data.candidates[0].content.parts[0].text;
        chatHistory.push({ role: "model", parts: [{ text: aiText }] });
        
        // ë©”ëª¨ë¦¬ ìµœì í™” (ìµœê·¼ 12ê°œ ë©”ì‹œì§€ ìœ ì§€)
        if(chatHistory.length > 12) chatHistory.splice(0, 2);
        
        return aiText;
    } catch (error) {
        console.error(error);
        return "âš ï¸ ì˜¤ë¥˜: API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ë´. (Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ê°€ í•„ìš”í•´!)";
    } finally {
        loading.classList.add('hidden');
    }
}

/* ================= FORM EVENT ================= */
document.getElementById('form').onsubmit = async (e) => {
    e.preventDefault();
    const inputField = document.getElementById('input');
    const text = inputField.value.trim();
    const img = selectedImageBase64;

    if (!text && !img) return;

    addUser(text, img);
    inputField.value = "";
    const tempImg = img;
    clearImage();

    const aiRes = await askGemini(text, tempImg);
    addAI(aiRes);
};
</script>

</body>
</html>
